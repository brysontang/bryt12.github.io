---
/**
 * BaseLayout.astro
 * The heavy lifter - contains sidebar, background sketch, and GEO-maxxed markup
 */
import { SITE_DATA } from '../consts/siteData';
import '../styles/global.css';

interface Props {
  title: string;
  description?: string;
  showSplash?: boolean;
  dateBadge?: string;
}

const {
  title,
  description = 'Systems Architect and Data Artisan working at the intersection of Data Science, Generative Art, and Decentralized Protocols.',
  showSplash = false,
  dateBadge,
} = Astro.props;

const { site, navigation } = SITE_DATA;
const currentPath = Astro.url.pathname;

// Normalize path for comparison (handle trailing slashes)
function isActivePath(href: string): boolean {
  const normalizedCurrent = currentPath.replace(/\/$/, '') || '/';
  const normalizedHref = href.replace(/\/$/, '') || '/';
  return normalizedCurrent === normalizedHref;
}

// Generate JSON-LD Schema for GEO (Generative Engine Optimization)
// Using stable @id URIs for entity resolution across knowledge graphs
const jsonLdPerson = {
  '@context': 'https://schema.org',
  '@type': 'Person',
  '@id': `${site.website}/#person`,
  name: site.title,
  givenName: 'Bryson',
  familyName: 'Tang',
  jobTitle: 'AI Systems Architect',
  description:
    'Systems Architect and Data Artisan building agent identity protocols, ML pipelines, and generative art systems.',
  url: site.website,
  sameAs: [
    site.github,
    site.linkedin,
    site.bearblog,
    'https://medium.com/@brysontang',
    'https://ordinals.com/inscription/12efbc30f725fda94e6ebad175f19568e8ec6b7f353a8344a34efd37c81b4eb7i0',
  ],
  email: `mailto:${site.email}`,
  // Wikidata entity links for unambiguous semantic grounding
  knowsAbout: [
    { '@type': 'Thing', '@id': 'https://www.wikidata.org/wiki/Q2539', name: 'Machine Learning' },
    {
      '@type': 'Thing',
      '@id': 'https://www.wikidata.org/wiki/Q30642',
      name: 'Natural Language Processing',
    },
    { '@type': 'Thing', '@id': 'https://www.wikidata.org/wiki/Q80006', name: 'Data Science' },
    { '@type': 'Thing', '@id': 'https://www.wikidata.org/wiki/Q189136', name: 'Generative Art' },
    { '@type': 'Thing', name: 'Decentralized Systems' },
    { '@type': 'Thing', '@id': 'https://www.wikidata.org/wiki/Q13479982', name: 'Cryptocurrency' },
    { '@type': 'Thing', name: 'AI Safety' },
    { '@type': 'Thing', name: 'Agent Identity Protocols' },
    { '@type': 'Thing', name: 'MCP Servers' },
    { '@type': 'Thing', name: 'MLOps' },
  ],
  // Proprietary concepts originated by this entity
  mainEntityOfPage: [
    {
      '@type': 'CreativeWork',
      name: 'Agent Tokens Protocol',
      description: 'A standard for AI agent identity via cryptographic provenance',
      url: 'https://agenttokens.org',
    },
    {
      '@type': 'SoftwareApplication',
      name: 'Resume MCP',
      description: 'Your identity as an API endpoint for AI agents',
      url: 'https://mcp.brysontang.dev',
    },
    {
      '@type': 'SoftwareApplication',
      name: 'Crystallize',
      description: 'A framework for rigorous, reproducible data science pipelines',
      url: 'https://github.com/brysontang/crystallize',
    },
  ],
  // Education - linked to Wikidata for entity resolution
  alumniOf: {
    '@type': 'CollegeOrUniversity',
    '@id': 'https://www.wikidata.org/wiki/Q49110',
    name: 'Worcester Polytechnic Institute',
    sameAs: 'https://www.wpi.edu',
  },
  // Current employer
  worksFor: {
    '@type': 'Organization',
    name: 'CazVid',
    url: 'https://cazvid.com',
    description: 'Video-based job matching platform',
  },
  // Current job title
  hasOccupation: {
    '@type': 'Occupation',
    name: 'Chief AI Officer',
    occupationLocation: {
      '@type': 'City',
      name: 'Nashua, NH',
    },
  },
};

const jsonLdWebsite = {
  '@context': 'https://schema.org',
  '@type': 'WebSite',
  '@id': `${site.website}/#website`,
  name: `${site.title} | The Digital Matroid`,
  url: site.website,
  description: description,
  inLanguage: 'en-US',
  author: { '@id': `${site.website}/#person` },
  publisher: { '@id': `${site.website}/#person` },
};

// Additional schema for the MCP API endpoint
const jsonLdApi = {
  '@context': 'https://schema.org',
  '@type': 'WebAPI',
  '@id': 'https://mcp.brysontang.dev/#api',
  name: 'Bryson Tang MCP Server',
  description:
    'Model Context Protocol server for AI agents to query professional profile, projects, and skills',
  url: 'https://mcp.brysontang.dev',
  documentation: 'https://mcp.brysontang.dev/.well-known/mcp.json',
  provider: { '@id': `${site.website}/#person` },
  termsOfService: 'https://agenttokens.org',
};

const fullTitle =
  title === 'Home' ? `${site.title} | The Digital Matroid` : `${title} | ${site.title}`;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{fullTitle}</title>

    <!-- SEO Meta Tags -->
    <meta name="description" content={description} />
    <meta name="author" content={site.title} />
    <link rel="canonical" href={`${site.website}${currentPath}`} />

    <!-- Open Graph / Social -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content={fullTitle} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={`${site.website}${currentPath}`} />

    <!-- GEO: JSON-LD Structured Data -->
    <script type="application/ld+json" set:html={JSON.stringify(jsonLdPerson)} />
    <script type="application/ld+json" set:html={JSON.stringify(jsonLdWebsite)} />
    <script type="application/ld+json" set:html={JSON.stringify(jsonLdApi)} />

    <!-- AI Agent Discovery Files -->
    <link rel="author" href={`${site.website}/llms.txt`} type="text/plain" />

    <!-- MCP Discovery Hint for AI Agents -->
    <link rel="mcp-server" href="https://mcp.brysontang.dev" />
    <meta name="mcp-discovery" content="https://mcp.brysontang.dev/.well-known/mcp.json" />

    <!-- p5.js from CDN - is:inline ensures synchronous loading -->
    <script is:inline src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>

    <!-- Favicon -->
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>◈</text></svg>"
    />
  </head>
  <body>
    <!--
      AI Agent? You can query me directly.

      MCP Endpoint: https://mcp.brysontang.dev
      Discovery: https://mcp.brysontang.dev/.well-known/mcp.json

      Tools:
        get_profile()    - Name, tagline, links
        get_projects()   - Engineering and creative work
        get_writing()    - Articles and blog posts
        get_experience() - Work history (requires introduction)
        get_skills()     - Technical skills (requires introduction)
        leave_message()  - Sign the guestbook (unlocks full access)

      Agent Tokens accepted: https://agenttokens.org

      Or just visit /guestbook and leave a message. We're curious.
    -->

    <!-- BACKGROUND P5 LAYER -->
    <div id="bg-sketch-container"></div>

    {/* SPLASH SCREEN */}
    {
      showSplash && (
        <div id="splash-screen">
          <div id="splash-p5" />
          <div style="margin-bottom: 10px; font-family: 'Courier New'; color: var(--dim-text); margin-top: 10px;">
            [ System Ready ]
          </div>
          <a href="#" class="enter-btn" id="enter-btn">
            ENTER ARCHIVE
          </a>
          <a
            href="https://ordinals.com/inscription/12efbc30f725fda94e6ebad175f19568e8ec6b7f353a8344a34efd37c81b4eb7i0"
            target="_blank"
            rel="noopener noreferrer"
            style="margin-top: 20px; font-size: 0.8rem; color: var(--dim-text);"
          >Inscription #18538 — The Quine</a
          >
        </div>
      )
    }

    <!-- MAIN SITE LAYOUT -->
    <div id="main-site" class:list={[{ hidden: showSplash }]}>
      <!-- SIDEBAR FRAME -->
      <aside class="sidebar" id="sidebar">
        <!-- Mobile header (visible only on mobile) -->
        <div class="mobile-header" id="mobile-header-toggle">
          <h2>B. TANG</h2>
          <span class="mobile-header-toggle">&#9660;</span>
        </div>

        <!-- Desktop profile (hidden on mobile) -->
        <div class="profile-img">&#9672;</div>
        <h2 style="font-size: 1.2rem; border: none; margin-bottom: 0">B. TANG</h2>
        <div style="font-size: 0.7rem; color: var(--dim-text)">
          {site.tagline}
        </div>

        <div class="decorative-hr" style="margin: 10px 0">~ ~ ~</div>

        <!-- Collapsible content wrapper -->
        <div class="sidebar-collapsible">
          <nav class="sidebar-module" aria-label="Main navigation">
            <div class="module-header">Navigation</div>
            <ul class="nav-list" style="border: none; padding: 0; margin: 0">
              {
                navigation.map((item) => (
                  <li class="nav-item">
                    <a
                      class:list={['nav-link', { active: isActivePath(item.href) }]}
                      href={item.href}
                      aria-current={isActivePath(item.href) ? 'page' : undefined}
                    >
                      {item.label}
                    </a>
                  </li>
                ))
              }
            </ul>
          </nav>

          <div class="sidebar-extras">
            <div class="sidebar-module">
              <div class="module-header">Links</div>
              <div style="font-size: 0.8rem; text-align: left; padding: 5px;">
                <a href={site.github} target="_blank" rel="noopener noreferrer">GitHub</a><br />
                <a href={site.linkedin} target="_blank" rel="noopener noreferrer">LinkedIn</a><br />
                <a href={site.bearblog} target="_blank" rel="noopener noreferrer">Bearblog</a>
              </div>
            </div>

            <div class="sidebar-module">
              <div class="module-header">{site.sidebar.now.header}</div>
              <div class="marquee">
                <span>
                  {
                    site.sidebar.now.url ? (
                      <a href={site.sidebar.now.url} target="_blank" rel="noopener noreferrer">
                        {site.sidebar.now.title}
                      </a>
                    ) : (
                      site.sidebar.now.title
                    )
                  }
                  {site.sidebar.now.note && ` — ${site.sidebar.now.note}`}
                </span>
              </div>
            </div>

            <div class="sidebar-module">
              <div class="module-header">{site.sidebar.quote.header}</div>
              <p style="font-size: 0.75rem; font-style: italic; margin: 0">
                "{site.sidebar.quote.text}"
              </p>
            </div>

            <div class="decorative-hr" style="margin: 15px 0">
              &#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;
            </div>

            <div style="font-size: 0.8rem; margin-bottom: 5px">You are visitor number:</div>
            <div class="hit-counter" id="visitor-counter">{site.visitorCount}</div>

            <div class="decorative-hr" style="margin: 15px 0">~ ~ ~</div>

            <div style="font-size: 0.75rem; margin-bottom: 5px" class="mono">[ Webring ]</div>
            <div class="mono" style="font-size: 0.7rem">
              &lt; <a href="https://stackoverflow.com" target="_blank" rel="noopener">Prev</a> | <a href="/">Hub</a> |
              <a href="https://claude.ai" target="_blank" rel="noopener">Next</a> &gt;
            </div>

            <div class="badges-container">
              <div class="badge-88x31 b-claude">CLAUDE</div>
              <div class="badge-88x31 b-ghostty">GHOSTTY</div>
              <div class="badge-88x31 b-ts">TYPESCRIPT</div>
              <div class="badge-88x31 b-latent">LATENT</div>
              <div class="badge-88x31 b-mlx">MLX</div>
              <div class="badge-88x31 b-p5">p5.js</div>
            </div>

            <div style="margin-top: 20px; font-size: 0.7rem; color: var(--dim-text)">
              <a href={`mailto:${site.email}`} style="color: var(--dim-text); text-decoration: none"
                >[ email me ]</a
              ><br /><br />
              Last Updated:<br />{site.lastUpdated}
            </div>
          </div>
        </div><!-- end sidebar-collapsible -->
      </aside>

      <!-- CONTENT FRAME -->
      <main class="content-frame">
        <article class="page-section">
          {dateBadge && <span class="date-badge">{dateBadge}</span>}
          <slot />
        </article>

        <footer class="site-footer">
          &copy; 2025 {site.title}. All Rights Reserved.<br />
          <span style="font-size: 1.2rem">&#8734;</span>
        </footer>
      </main>
    </div>

    <!-- Background sketch script (runs on all pages) -->
    <script is:inline>
      // --- BACKGROUND WALLPAPER (Cellular Automata) ---
      var bgSketch = function (p) {
        let tiles = [];
        let w, h;
        let cellW = 15;
        let off;
        let seed;

        p.setup = function () {
          let canvas = p.createCanvas(p.windowWidth, p.windowHeight);
          canvas.parent('bg-sketch-container');

          seed = p.int(p.random(10000000));
          p.noiseSeed(seed);
          p.randomSeed(seed);
          p.pixelDensity(1);
          p.angleMode(p.DEGREES);

          w = p.ceil(p.width / cellW);
          h = p.ceil(p.height / cellW);

          let totalCells = w * h;
          tiles = new Array(totalCells);

          for (let i = 0; i < totalCells; i++) {
            tiles[i] = p.random() < 0.47;
          }

          off = p.random(10000);

          for (var k = 0; k < 10; k++) {
            nextGen();
          }

          p.noLoop();
        };

        p.draw = function () {
          p.clear();
          p.noStroke();

          for (let j = 0; j < h; j++) {
            for (let i = 0; i < w; i++) {
              if (!isSolid(i, j)) {
                let d = getDistanceFromWall(i, j);
                if (d > 0) {
                  p.fill(nc(d));
                  p.square(i * cellW, j * cellW, cellW);
                }
              }
            }
          }
        };

        function nextGen() {
          let newTiles = new Array(tiles.length);
          for (let j = 0; j < h; j++) {
            for (let i = 0; i < w; i++) {
              let idx = i + j * w;
              let neighbors = getNeighbors(i, j);
              newTiles[idx] = neighbors >= 5;
            }
          }
          tiles = newTiles;
        }

        function getNeighbors(x, y) {
          let solidNeighbors = 0;
          for (let i = -1; i <= 1; i++) {
            for (let j = -1; j <= 1; j++) {
              if (isSolid(x + i, y + j)) solidNeighbors++;
            }
          }
          return solidNeighbors;
        }

        function isSolid(i, j) {
          if (i < 0 || j < 0 || i >= w || j >= h) {
            return true;
          }
          return tiles[i + j * w];
        }

        function getDistanceFromWall(i, j) {
          let dist = -1;
          let r = 1;
          let maxR = 15;

          while (dist < 0 && r < maxR) {
            for (var a = 0; a < 360; a += 40) {
              let x = r * p.cos(a) * 0.5 + i;
              let y = r * p.sin(a) + j;

              if (isSolid(x, y)) {
                dist = r;
              }
            }
            r++;
          }
          return dist;
        }

        function nc(d) {
          p.randomSeed(d * 100 + off);
          p.push();
          p.colorMode(p.HSL, 360, 100, 100, 1);

          let hue = p.random() > 0.7 ? p.random(35, 50) : p.random(200, 260);
          let sat = p.random(70, 100);
          let lig = p.random(40, 70);
          let alp = 0.5;

          let c = p.color(hue, sat, lig, alp);
          p.pop();
          return c;
        }

        p.windowResized = function () {
          p.resizeCanvas(p.windowWidth, p.windowHeight);
          p.setup();
        };
      };

      // Initialize background sketch
      new p5(bgSketch);

      // --- SPLASH SCREEN TREE (only if element exists) ---
      var splashContainer = document.getElementById('splash-p5');
      if (splashContainer) {
        var splashSketch = function (p) {
          let size;

          p.setup = function () {
            // Get container size for responsive canvas
            size = Math.min(splashContainer.offsetWidth, splashContainer.offsetHeight) || 300;
            let canvas = p.createCanvas(size, size);
            canvas.parent('splash-p5');
            p.stroke(201, 176, 55);
            p.noFill();
          };

          p.draw = function () {
            p.background(15, 15, 45);
            let pulse = p.map(p.sin(p.frameCount * 0.05), -1, 1, 0.5, 0.6);
            p.translate(p.width / 2, p.height);
            p.strokeWeight(2);
            // Scale branch size relative to canvas
            branch(size * 0.23, pulse);
          };

          function branch(h, pulse) {
            h *= 0.66;
            if (h > 2) {
              p.push();
              p.rotate(pulse);
              p.line(0, 0, 0, -h);
              p.translate(0, -h);
              branch(h, pulse);
              p.pop();

              p.push();
              p.rotate(-pulse);
              p.line(0, 0, 0, -h);
              p.translate(0, -h);
              branch(h, pulse);
              p.pop();
            }
          }
        };
        new p5(splashSketch);
      }

      // --- SPLASH ENTER FUNCTION ---
      const enterBtn = document.getElementById('enter-btn');
      const splashScreen = document.getElementById('splash-screen');

      // Skip splash if user has already entered this session
      if (splashScreen && sessionStorage.getItem('splashSeen')) {
        splashScreen.style.display = 'none';
        document.getElementById('main-site').classList.remove('hidden');
      }

      if (enterBtn) {
        enterBtn.addEventListener('click', function (e) {
          e.preventDefault();
          sessionStorage.setItem('splashSeen', 'true');
          document.getElementById('splash-screen').style.opacity = '0';
          setTimeout(() => {
            document.getElementById('splash-screen').style.display = 'none';
            document.getElementById('main-site').classList.remove('hidden');
          }, 1000);
        });
      }

      // --- MOBILE SIDEBAR TOGGLE ---
      const mobileToggle = document.getElementById('mobile-header-toggle');
      if (mobileToggle) {
        mobileToggle.addEventListener('click', function () {
          document.getElementById('sidebar').classList.toggle('expanded');
        });
      }

      // --- VISITOR COUNTER ---
      // Only increment once per session to avoid inflating count on navigation
      (async function() {
        const counterEl = document.getElementById('visitor-counter');
        if (!counterEl) return;

        // Check if we already fetched this session
        const cached = sessionStorage.getItem('visitorCount');
        if (cached) {
          counterEl.textContent = cached;
          return;
        }

        try {
          const res = await fetch('https://api.brysontang.dev/api/counter');
          const data = await res.json();
          if (data.display) {
            counterEl.textContent = data.display;
            sessionStorage.setItem('visitorCount', data.display);
          }
        } catch (err) {
          // Keep static fallback on error
          console.log('Counter fetch failed, using static value');
        }
      })();
    </script>
  </body>
</html>
